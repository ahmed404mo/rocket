<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³ØªÙƒØ´Ù Ø§Ù„ÙØ¶Ø§Ø¡: Ø§Ù„Ù‡Ø¨ÙˆØ· Ø¨Ø§Ù„Ù…Ø¸Ù„Ø§Øª</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Cairo', sans-serif;
            color: white;
            user-select: none;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
            cursor: crosshair;
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .screen {
            background: rgba(16, 24, 48, 0.95);
            padding: 40px;
            border-radius: 25px;
            border: 4px solid #00d2ff;
            text-align: center;
            pointer-events: auto;
            box-shadow: 0 0 50px rgba(0, 210, 255, 0.3);
            display: none;
            max-width: 600px;
            backdrop-filter: blur(10px);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .screen.active { display: block; }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        h1 {
            color: #ffeb3b;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #ff9800;
        }

        h2 { color: #00d2ff; margin-top: 0; }

        p {
            font-size: 1.3rem;
            color: #fff;
            line-height: 1.6;
        }

        .fact-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px dashed #aaa;
            font-size: 1.1rem;
            color: #eee;
        }

        button {
            background: linear-gradient(to bottom, #4caf50, #2e7d32);
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            color: white;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            margin-top: 20px;
            box-shadow: 0 5px 0 #1b5e20;
            transition: all 0.1s;
        }

        button:active {
            transform: translateY(5px);
            box-shadow: none;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        #workshop-ui {
            position: absolute;
            top: 0;
            right: 0; 
            width: 160px; 
            height: 100%;
            background: rgba(20, 30, 50, 0.95);
            border-left: 3px solid #444;
            display: none; 
            flex-direction: column;
            z-index: 20;
            box-shadow: -5px 0 20px rgba(0,0,0,0.5);
        }

        .parts-scroll-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            scrollbar-width: thin;
        }
        
        .launch-area {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid #555;
            flex-shrink: 0;
        }

        .toolbar-label {
            font-size: 1rem;
            color: #ffeb3b;
            margin: 15px 0 5px 0;
            border-bottom: 2px solid #555;
            text-align: center;
            font-weight: bold;
        }
        .toolbar-label:first-child { margin-top: 0; }

        .toolbar-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .part-btn {
            width: 65px;
            height: 65px;
            border: 2px solid #555;
            background: #333;
            border-radius: 12px;
            cursor: grab; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            color: #fff;
            flex-direction: column;
            position: relative;
            box-shadow: 0 4px 0 #222;
        }

        .part-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #222;
        }

        .delete-btn {
            background: #d32f2f !important;
            border-color: #b71c1c !important;
            width: 100%; 
            height: 50px;
            flex-direction: row;
            gap: 10px;
            margin-top: 20px;
        }

        #launch-btn {
            background: linear-gradient(to bottom, #ff9800, #f57c00);
            width: 100%;
            height: 70px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1.4rem;
            padding: 0;
            box-shadow: 0 5px 0 #e65100;
            margin: 0;
            animation: pulse-btn 2s infinite;
        }
        
        @keyframes pulse-btn {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
        #color-picker {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 30px;
            display: flex;
            gap: 10px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            border: 2px solid #00d2ff;
            z-index: 15;
        }
        
        #color-picker.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .color-swatch {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .color-swatch:hover { transform: scale(1.2); }

        /* HUD Ø§Ù„Ø·ÙŠØ±Ø§Ù† */
        #flight-hud {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
            display: none;
            pointer-events: none;
            z-index: 5;
        }

        .hud-box {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ffeb3b;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            color: #fff;
            font-family: 'Cairo', sans-serif;
            font-size: 1.2rem;
        }

        #heat-warning {
            color: #ff3d00;
            font-weight: bold;
            display: none;
            animation: blink 0.5s infinite;
        }
        
        #fuel-low-warning {
            color: #ff0000;
            font-weight: bold;
            display: none;
            animation: blink 0.3s infinite;
        }

        #solar-charging {
            color: #00e676;
            font-weight: bold;
            display: none;
            font-size: 0.9rem;
        }
        
        #driving-mode {
            color: #00d2ff;
            font-weight: bold;
            display: none;
            font-size: 0.9rem;
            border: 1px solid #00d2ff;
        }
        
        /* Ø²Ø± Ø§Ù„Ù…Ø¸Ù„Ø© */
        #chute-btn {
            background: #95a5a6;
            border: 2px solid #7f8c8d;
            font-size: 1rem;
            padding: 10px 20px;
            margin-top: 5px;
            pointer-events: auto;
            border-radius: 50px;
            cursor: pointer;
            color: white;
            font-family: 'Cairo', sans-serif;
            display: block; /* ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø·ÙŠØ±Ø§Ù† */
            width: 100%;
            transition: background 0.3s;
        }
        #chute-btn.deployed {
            background: #e67e22;
            border-color: #d35400;
        }
        
        @keyframes blink { 50% { opacity: 0.5; } }

        #launch-status {
            color: #00e676;
            font-weight: bold;
            animation: pulse-text 1s infinite;
        }
        
        @keyframes pulse-text { 50% { opacity: 0.5; } }

        #return-workshop-btn {
            background: #3498db;
            border: 2px solid #2980b9;
            font-size: 1rem;
            padding: 8px 15px;
            margin-top: 5px;
            pointer-events: auto;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-family: 'Cairo', sans-serif;
        }
        #return-workshop-btn:hover {
            background: #2980b9;
        }
        
        #nav-arrow {
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #ffeb3b;
            transform-origin: 50% 100%;
            display: none;
            pointer-events: none;
            z-index: 4;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>
    
    <div id="nav-arrow"></div>

    <div class="ui-layer">
        <div id="start-screen" class="screen active">
            <h1>ğŸ› ï¸ Ù…Ø­Ø·Ø© Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØµÙˆØ§Ø±ÙŠØ® ğŸš€</h1>
            <p>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³!</p>
            <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ±ÙƒÙŠØ¨ <b>Ø§Ù„Ø¹Ø¬Ù„Ø§Øª</b> Ù„Ù„Ù‚ÙŠØ§Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ§ÙƒØ¨!</p>
            <button onclick="startGame()">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆØ±Ø´Ø©</button>
        </div>

        <div id="success-screen" class="screen">
            <h1 style="color: #76ff03;">Ù‡Ø¨ÙˆØ· Ù†Ø§Ø¬Ø­! ğŸš©</h1>
            <h2 id="planet-name-display">Ø§Ø³Ù… Ø§Ù„ÙƒÙˆÙƒØ¨</h2>
            <div class="fact-box">
                <p id="planet-fact-display">Ù…Ø¹Ù„ÙˆÙ…Ø© Ù‡Ù†Ø§...</p>
            </div>
            <button onclick="continueMission()">Ø§Ù†Ø·Ù„Ù‚ Ù„Ù„ÙƒÙˆÙƒØ¨ Ø§Ù„ØªØ§Ù„ÙŠ</button>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
    <div id="color-picker">
        <div class="color-swatch" style="background:#bdc3c7" onclick="setColor('#bdc3c7')"></div>
        <div class="color-swatch" style="background:#e74c3c" onclick="setColor('#e74c3c')"></div>
        <div class="color-swatch" style="background:#f39c12" onclick="setColor('#f39c12')"></div>
        <div class="color-swatch" style="background:#2980b9" onclick="setColor('#2980b9')"></div>
        <div class="color-swatch" style="background:#27ae60" onclick="setColor('#27ae60')"></div>
        <div class="color-swatch" style="background:#9b59b6" onclick="setColor('#9b59b6')"></div>
        <div class="color-swatch" style="background:#ecf0f1" onclick="setColor('#ecf0f1')"></div>
        <div class="color-swatch" style="background:#34495e" onclick="setColor('#34495e')"></div>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙˆØ±Ø´Ø© -->
    <div id="workshop-ui">
        <div class="parts-scroll-container">
            <div class="toolbar-label">Ø§Ù„Ø¨Ù†Ø§Ø¡</div>
            <div class="toolbar-group">
                <div class="part-btn" onmousedown="startDragFromUI(event, 'hull')" title="Ù‡ÙŠÙƒÙ„">
                    <div style="width: 20px; height: 25px; background: #bdc3c7; border: 1px solid #fff;"></div>
                    <span>Ù‡ÙŠÙƒÙ„</span>
                </div>
                <div class="part-btn" onmousedown="startDragFromUI(event, 'tank')" title="Ø®Ø²Ø§Ù† ÙˆÙ‚ÙˆØ¯">
                    <div style="width: 18px; height: 28px; background: #ecf0f1; border-radius: 5px;"></div>
                    <span>Ø®Ø²Ø§Ù†</span>
                </div>
                <div class="part-btn" onmousedown="startDragFromUI(event, 'nose')" title="Ù…Ù‚Ø¯Ù…Ø©">
                    <div style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid #00d2ff;"></div>
                    <span>Ù…Ù‚Ø¯Ù…Ø©</span>
                </div>
                <div class="part-btn" onmousedown="startDragFromUI(event, 'cabin')" title="Ù‚Ù…Ø±Ø©">
                    <div style="width: 20px; height: 15px; background: #3498db; border-radius: 15px 15px 0 0; border: 1px solid #fff;"></div>
                    <span>Ù‚Ù…Ø±Ø©</span>
                </div>
            </div>

            <div class="toolbar-label">Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª</div>
            <div class="toolbar-group">
                <div class="part-btn" onmousedown="startDragFromUI(event, 'engine')" title="Ù…Ø­Ø±Ùƒ Ù†Ø§Ø±ÙŠ">
                    <div style="width: 15px; height: 20px; background: #e67e22; border-bottom: 3px solid red;"></div>
                    <span>Ù…Ø­Ø±Ùƒ</span>
                </div>
                <div class="part-btn" onmousedown="startDragFromUI(event, 'ion')" title="Ù…Ø­Ø±Ùƒ Ø£ÙŠÙˆÙ†ÙŠ">
                    <div style="width: 18px; height: 18px; border-radius: 50%; background: #2980b9; border: 2px solid #fff;"></div>
                    <span>Ø£ÙŠÙˆÙ†ÙŠ</span>
                </div>
            </div>

            <div class="toolbar-label">Ø£Ø¯ÙˆØ§Øª ÙˆÙ‡Ø¨ÙˆØ·</div>
            <div class="toolbar-group">
                <div class="part-btn" onmousedown="startDragFromUI(event, 'parachute')" title="Ù…Ø¸Ù„Ø© Ù‡Ø¨ÙˆØ·">
                    <div style="width: 25px; height: 15px; background: #fff; border-radius: 10px 10px 2px 2px; border: 1px solid #aaa;"></div>
                    <span>Ù…Ø¸Ù„Ø©</span>
                </div>
                <div class="part-btn" onmousedown="startDragFromUI(event, 'leg')" title="Ø±Ø¬Ù„ Ù‡Ø¨ÙˆØ·">
                    <div style="width: 4px; height: 25px; background: #fff; transform: skewX(-10deg);"></div>
                    <span>Ø±Ø¬Ù„</span>
                </div>
                <div class="part-btn" onmousedown="startDragFromUI(event, 'wheel')" title="Ø¹Ø¬Ù„Ø©">
                     <div style="width: 20px; height: 20px; border-radius: 50%; background: #333; border: 2px solid #888;"></div>
                    <span>Ø¹Ø¬Ù„Ø©</span>
                </div>
                <div class="part-btn" onmousedown="startDragFromUI(event, 'wing')" title="Ø¬Ù†Ø§Ø­">
                    <div style="width: 0; height: 0; border-bottom: 20px solid #95a5a6; border-right: 10px solid transparent;"></div>
                    <span>Ø¬Ù†Ø§Ø­</span>
                </div>
            </div>
             <div class="toolbar-group">
                <div class="part-btn" onmousedown="startDragFromUI(event, 'solar')" title="Ø·Ø§Ù‚Ø© Ø´Ù…Ø³ÙŠØ©">
                    <div style="width: 25px; height: 8px; background: #2c3e50; border: 1px solid #3498db;"></div>
                    <span>Ø·Ø§Ù‚Ø©</span>
                </div>
            
                <div class="part-btn" onmousedown="startDragFromUI(event, 'cargo')" title="ØµÙ†Ø¯ÙˆÙ‚">
                    <div style="width: 20px; height: 20px; background: #d35400; border: 1px dashed #fff;"></div>
                    <span>ØµÙ†Ø¯ÙˆÙ‚</span>
                </div>
             </div>

            <div class="toolbar-group">
                 <div class="part-btn delete-btn" onclick="deleteSelectedPart()" title="Ø­Ø°Ù Ø§Ù„Ù‚Ø·Ø¹Ø©">
                    <div style="font-size: 20px;">ğŸ—‘ï¸</div>
                    <span>Ø­Ø°Ù</span>
                </div>
            </div>
        </div>

        <div class="launch-area">
            <button id="launch-btn" onclick="launchRocket()">Ø§Ù†Ø·Ù„Ø§Ù‚ ğŸš€</button>
        </div>
    </div>

    <!-- Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·ÙŠØ±Ø§Ù† -->
    <div id="flight-hud">
        <div class="hud-box">Ø§Ù„Ø­Ø§Ù„Ø©: <span id="launch-status">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ù‚Ù„Ø§Ø¹</span></div>
        <div class="hud-box">Ø§Ù„ÙˆÙ‚ÙˆØ¯: <span id="fuel-val" style="color:#00e676">100%</span></div>
        <div class="hud-box" id="solar-charging">â˜€ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø´Ø­Ù†...</div>
        <div class="hud-box" id="driving-mode">ğŸï¸ ÙˆØ¶Ø¹ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</div>
        <div class="hud-box">Ø§Ù„Ù‡Ø¯Ù: <span id="target-name" style="color:#ffeb3b"></span></div>
        <div class="hud-box">Ø§Ù„Ù…Ø³Ø§ÙØ©: <span id="dist-val">0</span> ÙƒÙ…</div>
        <div class="hud-box">Ø§Ù„Ø§Ø±ØªÙØ§Ø¹: <span id="alt-val">0</span></div>
        <div class="hud-box" id="heat-warning">âš ï¸ Ø­Ø±Ø§Ø±Ø© Ø§Ù„ØºÙ„Ø§Ù Ø§Ù„Ø¬ÙˆÙŠ!</div>
        <div class="hud-box" id="fuel-low-warning">âš ï¸ ÙˆÙ‚ÙˆØ¯ Ù…Ù†Ø®ÙØ¶!</div>
        
        <button id="chute-btn" onclick="toggleParachute()">ğŸª‚ ÙØªØ­ Ø§Ù„Ù…Ø¸Ù„Ø© (P)</button>
        <button id="return-workshop-btn" onclick="returnToWorkshop()">ğŸ› ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµØ§Ø±ÙˆØ®</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ© ---
        const planets = [
            { name: 'Ø¹Ø·Ø§Ø±Ø¯', x: -25000, y: 15000, radius: 600, color: '#95a5a6', type: 'mercury', visited: false, fact: 'Ø£Ù‚Ø±Ø¨ ÙƒÙˆÙƒØ¨ Ù„Ù„Ø´Ù…Ø³.', atm: false },
            { name: 'Ø§Ù„Ø²Ù‡Ø±Ø©', x: -12000, y: -12000, radius: 1200, color: '#e67e22', type: 'venus', visited: false, fact: 'ØºÙ„Ø§Ù Ø¬ÙˆÙŠ ÙƒØ«ÙŠÙ Ø¬Ø¯Ø§Ù‹!', atm: true, atmDensity: 2.5, atmColor: 'rgba(230, 126, 34, 0.6)' },
            { name: 'Ø§Ù„Ø£Ø±Ø¶', x: 0, y: 0, radius: 5000, color: '#1a4d8c', type: 'earth', visited: true, fact: 'Ø§Ù„ÙˆØ·Ù†.', atm: true, atmDensity: 1.0, atmColor: 'rgba(100, 181, 246, 0.5)' }, 
            { name: 'Ø§Ù„Ù‚Ù…Ø±', x: 0, y: -15000, radius: 400, color: '#bdc3c7', type: 'moon', visited: false, fact: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØºÙ„Ø§Ù Ø¬ÙˆÙŠ.', atm: false },
            { name: 'Ø§Ù„Ù…Ø±ÙŠØ®', x: 35000, y: -10000, radius: 900, color: '#c1440e', type: 'mars', visited: false, fact: 'ØºÙ„Ø§Ù Ø¬ÙˆÙŠ Ø±Ù‚ÙŠÙ‚.', atm: true, atmDensity: 0.3, atmColor: 'rgba(193, 68, 14, 0.4)' },
            
            { name: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠ', x: 80000, y: 0, radius: 3000, color: '#d35400', type: 'jupiter', visited: false, fact: 'Ø¹Ù…Ù„Ø§Ù‚ ØºØ§Ø²ÙŠ.', atm: true, atmDensity: 3.0, atmColor: 'rgba(211, 84, 0, 0.5)' },
            { name: 'Ø²Ø­Ù„', x: 120000, y: 15000, radius: 2500, color: '#f1c40f', type: 'saturn', visited: false, fact: 'Ø­Ù„Ù‚Ø§Øª ÙˆØºØ§Ø²Ø§Øª.', atm: true, atmDensity: 2.5, atmColor: 'rgba(241, 196, 15, 0.5)' },
            { name: 'Ø£ÙˆØ±Ø§Ù†ÙˆØ³', x: 160000, y: -5000, radius: 1800, color: '#7fdbff', type: 'uranus', visited: false, fact: 'Ø¨Ø§Ø±Ø¯ Ø¬Ø¯Ø§Ù‹.', atm: true, atmDensity: 2.0, atmColor: 'rgba(127, 219, 255, 0.5)' },
            { name: 'Ù†Ø¨ØªÙˆÙ†', x: 200000, y: 0, radius: 1800, color: '#3498db', type: 'neptune', visited: false, fact: 'Ø¹ÙˆØ§ØµÙ Ù‚ÙˆÙŠØ©.', atm: true, atmDensity: 2.2, atmColor: 'rgba(52, 152, 219, 0.5)' }
        ];

        let asteroids = [];
        let targetPlanetIndex = 2; 

        // --- Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        let gameState = 'START'; 
        let parts = [];
        let particles = []; 
        let stars = [];
        let hasLaunched = false; 
        
        let camera = { x: 0, y: 0, zoom: 1, shakeX: 0, shakeY: 0 }; 
        let rocket = { 
            x: 0, y: 0, 
            vx: 0, vy: 0, 
            angle: -Math.PI / 2,
            fuel: 0,
            maxFuel: 0,
            chuteDeployed: false, 
            wheelAngle: 0,
            landedPlanet: null // Ù„ØªØªØ¨Ø¹ Ø§Ù„ÙƒÙˆÙƒØ¨ Ø§Ù„Ø°ÙŠ Ù‡Ø¨Ø·Ù†Ø§ Ø¹Ù„ÙŠÙ‡
        };
        
        const GRID_SIZE = 40;
        let selectedPart = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let flagAnimation = { active: false, x: 0, y: 0, planet: null, frame: 0 };

        // --- ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù‚Ø·Ø¹ ---
        const PartTypes = {
            hull:     { w: 40, h: 40, color: '#bdc3c7', shape: 'hull' },
            tank:     { w: 40, h: 60, color: '#ecf0f1', shape: 'tank', fuel: 100 }, 
            nose:     { w: 40, h: 40, color: '#00d2ff', shape: 'nose' },
            cabin:    { w: 40, h: 30, color: '#3498db', shape: 'cabin' }, 
            engine:   { w: 30, h: 40, color: '#e67e22', shape: 'engine', thrust: 0.2, effect: 'fire', consumption: 0.05 }, 
            ion:      { w: 30, h: 30, color: '#2980b9', shape: 'ion', thrust: 0.1, effect: 'ion', consumption: 0.01 },
            wing:     { w: 40, h: 60, color: '#95a5a6', shape: 'wing' }, 
            leg:      { w: 20, h: 60, color: '#ecf0f1', shape: 'leg' },
            wheel:    { w: 30, h: 30, color: '#333', shape: 'wheel' }, // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ø¬Ù„Ø©
            solar:    { w: 60, h: 20, color: '#2c3e50', shape: 'solar' },
            cargo:    { w: 40, h: 40, color: '#d35400', shape: 'cargo' },
            parachute:{ w: 30, h: 20, color: '#fff', shape: 'chute_pack' } 
        };

        class Part {
            constructor(type, x, y) {
                this.type = type;
                this.def = PartTypes[type];
                this.x = Math.round(x / GRID_SIZE) * GRID_SIZE;
                this.y = Math.round(y / GRID_SIZE) * GRID_SIZE;
                this.color = this.def.color; 
            }

            draw(ctx, isFlying, wheelRotation = 0) {
                ctx.save();
                ctx.translate(this.x, this.y);
                if (isFlying) {
                    ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    ctx.shadowBlur = 10;
                }
                this.drawShape(ctx, this.def.shape, this.def.w, this.def.h, this.color, isFlying, wheelRotation);
                
                // Ø±Ø³Ù… Ø§Ù„Ù…Ø¸Ù„Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© (ÙÙŠ Ø§Ù„Ø·ÙŠØ±Ø§Ù† ÙÙ‚Ø·)
                if (isFlying && this.type === 'parachute' && rocket.chuteDeployed) {
                    this.drawDeployedChute(ctx);
                }

                ctx.restore();
            }

            drawDeployedChute(ctx) {
                ctx.save();
                // Ø§Ù„Ù…Ø¸Ù„Ø© ØªØ¸Ù‡Ø± "Ø£Ø¹Ù„Ù‰" Ø§Ù„ØµØ§Ø±ÙˆØ® (Ø§ØªØ¬Ø§Ù‡ -Y Ø§Ù„Ù…Ø­Ù„ÙŠ)
                // Ø­Ø¨Ø§Ù„
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(-10, -10); ctx.lineTo(-40, -80); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(10, -10); ctx.lineTo(40, -80); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, -10); ctx.lineTo(0, -80); ctx.stroke();

                // Ø§Ù„Ù‚Ù…Ø§Ø´ (Canopy)
                ctx.translate(0, -80);
                ctx.fillStyle = '#e67e22'; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙˆØ£Ø¨ÙŠØ¶
                ctx.beginPath();
                ctx.arc(0, 0, 50, Math.PI, 0); // Ù†ØµÙ Ø¯Ø§Ø¦Ø±Ø©
                ctx.lineTo(50, 10);
                ctx.quadraticCurveTo(0, 0, -50, 10);
                ctx.closePath();
                ctx.fill();
                
                // ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚Ù…Ø§Ø´
                ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, -50); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(35, -35); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-35, -35); ctx.stroke();

                ctx.restore();
            }

            drawShape(ctx, shape, w, h, baseColor, isFlying, wheelRotation) {
                let safeColor = baseColor || '#888888';
                let grad = ctx.createLinearGradient(-w/2, 0, w/2, 0);
                try {
                    grad.addColorStop(0, shadeColor(safeColor, -30));
                    grad.addColorStop(0.2, safeColor); 
                    grad.addColorStop(0.5, shadeColor(safeColor, 40)); 
                    grad.addColorStop(0.8, safeColor);
                    grad.addColorStop(1, shadeColor(safeColor, -30));
                } catch(e) { grad = safeColor; }
                ctx.fillStyle = grad;

                switch(shape) {
                    case 'hull':
                        ctx.fillRect(-w/2, -h/2, w, h);
                        ctx.fillStyle = 'rgba(0,0,0,0.3)';
                        ctx.fillRect(-w/2, -h/2, 2, h); 
                        ctx.fillRect(w/2-2, -h/2, 2, h); 
                        ctx.beginPath(); 
                        for(let i=-h/2+5; i<h/2; i+=10) { ctx.rect(-w/2+4, i, 2, 2); ctx.rect(w/2-6, i, 2, 2); }
                        ctx.fill();
                        break;
                    case 'tank':
                        ctx.beginPath(); ctx.roundRect(-w/2, -h/2, w, h, 8); ctx.fill();
                        ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.lineWidth = 2;
                        for(let i=-h/2+10; i<h/2; i+=10) { ctx.beginPath(); ctx.moveTo(-w/2+2, i); ctx.lineTo(w/2-2, i); ctx.stroke(); }
                        ctx.fillStyle = '#e74c3c'; ctx.font = '10px Arial'; ctx.fillText('FUEL', -12, 4);
                        break;
                    case 'nose':
                        ctx.beginPath(); ctx.moveTo(-w/2, h/2); ctx.quadraticCurveTo(0, -h/2-20, w/2, h/2); ctx.fill();
                        ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.beginPath(); ctx.ellipse(0, 0, 5, h/3, 0, 0, Math.PI*2); ctx.fill();
                        break;
                    case 'cabin':
                        ctx.beginPath(); 
                        ctx.moveTo(-w/2, h/2); ctx.lineTo(w/2, h/2); ctx.lineTo(w/2-5, -h/2+5); ctx.lineTo(-w/2+5, -h/2+5); ctx.fill();
                        ctx.fillStyle = '#81d4fa'; ctx.beginPath(); ctx.arc(0, 0, w/3.5, 0, Math.PI*2); ctx.fill();
                        ctx.strokeStyle = 'rgba(255,255,255,0.8)'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(0, 0, w/3.5-2, Math.PI, Math.PI*1.5); ctx.stroke();
                        break;
                    case 'engine':
                        let nozzleGrad = ctx.createLinearGradient(-w/2, -h/2, w/2, h/2);
                        nozzleGrad.addColorStop(0, '#444'); nozzleGrad.addColorStop(0.5, '#111'); nozzleGrad.addColorStop(1, '#444');
                        ctx.fillStyle = nozzleGrad;
                        ctx.beginPath(); ctx.moveTo(-w/2+5, -h/2); ctx.lineTo(w/2-5, -h/2); ctx.lineTo(w/2, h/2); ctx.lineTo(-w/2, h/2); ctx.fill();
                        ctx.strokeStyle = '#888'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(-w/2+8, -h/2); ctx.lineTo(-w/2+8, 0); ctx.stroke();
                        if (isFlying && inputs.up && rocket.fuel > 0) addExhaustParticle(this.x, this.y + h/2, rocket.angle, 'fire');
                        break;
                    case 'ion':
                        ctx.beginPath(); ctx.arc(0, 0, w/2, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(0, 0, w/2-4, 0, Math.PI*2); ctx.fill();
                        ctx.strokeStyle = '#00d2ff'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(-5,0); ctx.lineTo(5,0); ctx.moveTo(0,-5); ctx.lineTo(0,5); ctx.stroke();
                        if (isFlying && inputs.up && rocket.fuel > 0) addExhaustParticle(this.x, this.y + h/2, rocket.angle, 'ion');
                        break;
                    case 'wing':
                        ctx.beginPath(); ctx.moveTo(0, -h/2); ctx.lineTo(w/2, h/2); ctx.lineTo(-w/2, h/2); ctx.fill();
                        ctx.strokeStyle = 'rgba(0,0,0,0.3)'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(-w/2, h/4); ctx.lineTo(w/2, h/4); ctx.stroke();
                        break;
                    case 'leg':
                        ctx.fillStyle = '#bbb'; ctx.fillRect(-3, -h/2, 6, h); 
                        ctx.fillStyle = '#333'; ctx.fillRect(-12, h/2-4, 24, 4); 
                        break;
                    case 'wheel':
                        // Ø§Ù„Ø¹Ø¬Ù„Ø©
                        ctx.save();
                        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø·ÙŠØ±/Ù†Ù‚ÙˆØ¯
                        if (wheelRotation) ctx.rotate(wheelRotation);

                        ctx.fillStyle = '#1a1a1a';
                        ctx.beginPath(); ctx.arc(0, 0, w/2, 0, Math.PI*2); ctx.fill();
                        // Ø§Ù„Ø¬Ù†Ø·
                        ctx.fillStyle = '#bdc3c7';
                        ctx.beginPath(); ctx.arc(0, 0, w/2 - 5, 0, Math.PI*2); ctx.fill();
                        // Ù…Ø³Ø§Ù…ÙŠØ±
                        ctx.fillStyle = '#7f8c8d';
                        ctx.beginPath(); ctx.arc(0, 0, 3, 0, Math.PI*2); ctx.fill();
                        // Ø®Ø·ÙˆØ· Ø§Ù„Ø¥Ø·Ø§Ø± (ØªØ¯ÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø© ØªØªØ­Ø±Ùƒ)
                        ctx.strokeStyle = '#111'; ctx.lineWidth = 2;
                        
                        for(let i=0; i<8; i++) {
                            ctx.save(); ctx.rotate(i * Math.PI/4);
                            ctx.beginPath(); ctx.moveTo(w/2-5, 0); ctx.lineTo(w/2, 0); ctx.stroke();
                            ctx.restore();
                        }
                        ctx.restore();
                        break;
                    case 'solar':
                        ctx.fillStyle = '#222'; ctx.fillRect(-w/2, -h/2, w, h); 
                        ctx.fillStyle = '#1565c0'; 
                        let cols = 3; let rows = 2;
                        let cW = (w-4)/cols; let cH = (h-4)/rows;
                        for(let i=0; i<cols; i++) {
                            for(let j=0; j<rows; j++) {
                                ctx.fillRect(-w/2+2 + i*cW, -h/2+2 + j*cH, cW-1, cH-1);
                            }
                        }
                        ctx.fillStyle = 'rgba(255,255,255,0.2)';
                        ctx.beginPath(); ctx.moveTo(-w/2, -h/2); ctx.lineTo(0, h/2); ctx.lineTo(w/4, h/2); ctx.lineTo(-w/4, -h/2); ctx.fill();
                        break;
                    case 'cargo':
                        ctx.fillRect(-w/2, -h/2, w, h);
                        ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(-w/2, -h/2); ctx.lineTo(w/2, h/2); ctx.moveTo(w/2, -h/2); ctx.lineTo(-w/2, h/2); ctx.stroke();
                        break;
                    case 'chute_pack':
                        // Ø­Ù‚ÙŠØ¨Ø© Ø§Ù„Ù…Ø¸Ù„Ø©
                        ctx.fillStyle = '#eee';
                        ctx.beginPath(); ctx.roundRect(-w/2, -h/2, w, h, 4); ctx.fill();
                        ctx.fillStyle = '#d35400'; // Ø®Ø· Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
                        ctx.fillRect(-w/2, -2, w, 4);
                        break;
                }
            }
            
            isMouseOver(mx, my) {
                return mx > this.x - this.def.w/2 && mx < this.x + this.def.w/2 && my > this.y - this.def.h/2 && my < this.y + this.def.h/2;
            }
        }

        function shadeColor(color, percent) {
            if (!color) return '#000000';
            if (color.length === 4) { color = '#' + color[1] + color[1] + color[2] + color[2] + color[3] + color[3]; }
            var R = parseInt(color.substring(1,3),16);
            var G = parseInt(color.substring(3,5),16);
            var B = parseInt(color.substring(5,7),16);
            if (isNaN(R) || isNaN(G) || isNaN(B)) return color;
            R = parseInt(R * (100 + percent) / 100); R = (R<255)?R:255;
            G = parseInt(G * (100 + percent) / 100); G = (G<255)?G:255;
            B = parseInt(B * (100 + percent) / 100); B = (B<255)?B:255;
            var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
            var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
            var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
            return "#"+RR+GG+BB;
        }

        const inputs = { up: false, left: false, right: false, down: false };
        window.addEventListener('keydown', (e) => {
            if(e.key === 'ArrowUp' || e.key === 'w') inputs.up = true;
            if(e.key === 'ArrowLeft' || e.key === 'a') inputs.left = true;
            if(e.key === 'ArrowRight' || e.key === 'd') inputs.right = true;
            if(e.key === 'ArrowDown' || e.key === 's') inputs.down = true;
            if (gameState === 'FLY' && (e.key === 'p' || e.key === 'P')) toggleParachute();
            if (gameState === 'WORKSHOP' && (e.key === 'Delete' || e.key === 'Backspace')) deleteSelectedPart();
        });
        window.addEventListener('keyup', (e) => {
            if(e.key === 'ArrowUp' || e.key === 'w') inputs.up = false;
            if(e.key === 'ArrowLeft' || e.key === 'a') inputs.left = false;
            if(e.key === 'ArrowRight' || e.key === 'd') inputs.right = false;
            if(e.key === 'ArrowDown' || e.key === 's') inputs.down = false;
        });

        function startDragFromUI(e, type) {
            e.preventDefault(); 
            if (gameState !== 'WORKSHOP') return;
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - canvas.width/2) / camera.zoom + camera.x;
            const my = (e.clientY - rect.top - canvas.height/2) / camera.zoom + camera.y;
            let newPart = new Part(type, mx, my);
            parts.push(newPart);
            selectedPart = newPart;
            isDragging = true; 
            document.getElementById('color-picker').classList.add('visible');
        }

        canvas.addEventListener('mousedown', (e) => {
            if (gameState !== 'WORKSHOP') return;
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - canvas.width/2) / camera.zoom + camera.x;
            const my = (e.clientY - rect.top - canvas.height/2) / camera.zoom + camera.y;
            for (let i = parts.length - 1; i >= 0; i--) {
                if (parts[i].isMouseOver(mx, my)) {
                    selectedPart = parts[i];
                    parts.splice(i, 1); parts.push(selectedPart);
                    dragOffset.x = mx - selectedPart.x;
                    dragOffset.y = my - selectedPart.y;
                    isDragging = true;
                    document.getElementById('color-picker').classList.add('visible');
                    return;
                }
            }
            selectedPart = null;
            document.getElementById('color-picker').classList.remove('visible');
        });

        window.addEventListener('mousemove', (e) => {
            if (gameState !== 'WORKSHOP' || !selectedPart || !isDragging) return;
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left - canvas.width/2) / camera.zoom + camera.x;
            const my = (e.clientY - rect.top - canvas.height/2) / camera.zoom + camera.y;
            selectedPart.x = mx - dragOffset.x;
            selectedPart.y = my - dragOffset.y;
        });

        window.addEventListener('mouseup', (e) => {
            if (gameState !== 'WORKSHOP') return;
            isDragging = false;
            if (selectedPart) {
                selectedPart.x = Math.round(selectedPart.x / GRID_SIZE) * GRID_SIZE;
                selectedPart.y = Math.round(selectedPart.y / GRID_SIZE) * GRID_SIZE;
            }
        });

        function initStars() {
            stars = [];
            for(let i=0; i<800; i++) {
                stars.push({
                    x: (Math.random() - 0.5) * 200000, 
                    y: (Math.random() - 0.5) * 200000,
                    size: Math.random() * 2 + 0.5,
                    opacity: Math.random()
                });
            }
        }

        function initAsteroids() {
            asteroids = [];
            for(let i=0; i<150; i++) {
                asteroids.push({
                    x: 60000 + Math.random() * 15000, 
                    y: (Math.random() - 0.5) * 20000,
                    size: 20 + Math.random() * 60,
                    angle: Math.random() * Math.PI * 2,
                    speedRot: (Math.random() - 0.5) * 0.05
                });
            }
        }

        function startGame() {
            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('workshop-ui').style.display = 'flex';
            gameState = 'WORKSHOP';
            parts = [];
            let core = new Part('hull', 0, 0); core.color = '#eeeeee'; parts.push(core);
            camera = { x: 0, y: 0, zoom: 1, shakeX: 0, shakeY: 0 };
            initStars();
            initAsteroids();
        }

        function setColor(hex) { if (selectedPart) selectedPart.color = hex; }
        function deleteSelectedPart() {
            if (!selectedPart) return;
            if (parts.indexOf(selectedPart) === 0) { alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©!"); return; }
            parts.splice(parts.indexOf(selectedPart), 1);
            selectedPart = null;
            document.getElementById('color-picker').classList.remove('visible');
        }

        function returnToWorkshop() {
            gameState = 'WORKSHOP';
            document.getElementById('workshop-ui').style.display = 'flex';
            document.getElementById('flight-hud').style.display = 'none';
            document.getElementById('nav-arrow').style.display = 'none';
            document.getElementById('success-screen').classList.remove('active');
            
            camera = { x: 0, y: 0, zoom: 1, shakeX: 0, shakeY: 0 };
            rocket.vx = 0; rocket.vy = 0;
            rocket.angle = -Math.PI / 2;
            rocket.x = 0; rocket.y = 0;
            rocket.chuteDeployed = false;
            rocket.wheelAngle = 0;
            rocket.landedPlanet = null; // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø­Ø§Ù„Ø© Ø§Ù„Ù‡Ø¨ÙˆØ·
        }

        function launchRocket() {
            if (parts.length < 2) { alert("Ø§Ù„ØµØ§Ø±ÙˆØ® ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹!"); return; }
            let hasEngine = parts.some(p => p.type === 'engine' || p.type === 'ion');
            if (!hasEngine) { alert("ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø­Ø±Ùƒ Ù„Ù„Ø·ÙŠØ±Ø§Ù†!"); return; }
            
            let fuelTanks = parts.filter(p => p.type === 'tank');
            if (fuelTanks.length === 0) { alert("ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø®Ø²Ø§Ù† ÙˆÙ‚ÙˆØ¯ (Tank) Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…Ø­Ø±Ùƒ!"); return; }
            
            rocket.maxFuel = 0;
            fuelTanks.forEach(t => rocket.maxFuel += t.def.fuel);
            rocket.fuel = rocket.maxFuel;
            rocket.chuteDeployed = false;
            rocket.landedPlanet = null; // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù†Ø§ Ù„Ø³Ù†Ø§ ÙÙŠ Ø­Ø§Ù„Ø© Ù‡Ø¨ÙˆØ· Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡

            gameState = 'FLY';
            hasLaunched = false; 
            document.getElementById('launch-status').innerText = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ù‚Ù„Ø§Ø¹";
            document.getElementById('launch-status').style.color = "#00e676";
            document.getElementById('chute-btn').classList.remove('deployed');
            document.getElementById('chute-btn').innerText = "ğŸª‚ ÙØªØ­ Ø§Ù„Ù…Ø¸Ù„Ø© (P)";
            document.getElementById('driving-mode').style.display = "none";

            document.getElementById('workshop-ui').style.display = 'none';
            document.getElementById('color-picker').classList.remove('visible');
            document.getElementById('flight-hud').style.display = 'block';
            document.getElementById('nav-arrow').style.display = 'block';
            
            rocket.x = 0;
            rocket.y = -planets[2].radius - 60; 
            rocket.vx = 0; rocket.vy = 0;
            rocket.angle = -Math.PI / 2;
            
            camera.zoom = 1.2; 
            
            updateTarget();
        }
        
        function toggleParachute() {
            let hasChute = parts.some(p => p.type === 'parachute');
            if (!hasChute) {
                alert("Ù„Ù… ØªÙ‚Ù… Ø¨ØªØ±ÙƒÙŠØ¨ Ù…Ø¸Ù„Ø©!");
                return;
            }
            
            rocket.chuteDeployed = !rocket.chuteDeployed;
            let btn = document.getElementById('chute-btn');
            if (rocket.chuteDeployed) {
                btn.classList.add('deployed');
                btn.innerText = "Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¸Ù„Ø©";
            } else {
                btn.classList.remove('deployed');
                btn.innerText = "ÙØªØ­ Ø§Ù„Ù…Ø¸Ù„Ø© (P)";
            }
        }

        function updateTarget() {
            let minDist = Infinity;
            targetPlanetIndex = -1;

            for(let i=0; i<planets.length; i++) {
                if (!planets[i].visited && planets[i].type !== 'earth') {
                    let dx = rocket.x - planets[i].x;
                    let dy = rocket.y - planets[i].y;
                    let d = Math.sqrt(dx*dx + dy*dy);
                    if (d < minDist) {
                        minDist = d;
                        targetPlanetIndex = i;
                    }
                }
            }

            if(targetPlanetIndex === -1) targetPlanetIndex = 2; 
            
            document.getElementById('target-name').innerText = planets[targetPlanetIndex].name;
        }

        function addExhaustParticle(rx, ry, angle, type) {
            let offsetDist = Math.sqrt(rx*rx + ry*ry);
            let offsetAngle = Math.atan2(ry, rx) + angle + Math.PI/2; 
            let globalX = rocket.x + Math.cos(offsetAngle) * offsetDist;
            let globalY = rocket.y + Math.sin(offsetAngle) * offsetDist;
            let spread = (Math.random() - 0.5) * 0.4;
            let speed = -5 - Math.random() * 5;
            let color = type === 'ion' ? '#3498db' : (Math.random()>0.5?'#f39c12':'#e74c3c');
            let life = type === 'ion' ? 0.6 : 1.0;
            particles.push({ x: globalX, y: globalY, vx: rocket.vx + Math.cos(angle+spread)*speed, vy: rocket.vy + Math.sin(angle+spread)*speed, life: life, color: color, type: 'exhaust' });
        }

        function addHeatParticle(x, y, vx, vy) {
            particles.push({
                x: x + (Math.random()-0.5)*20,
                y: y + (Math.random()-0.5)*20,
                vx: vx * 0.5 + (Math.random()-0.5)*2,
                vy: vy * 0.5 + (Math.random()-0.5)*2,
                life: 0.5,
                color: Math.random() > 0.5 ? '#ff5722' : '#ff9800',
                type: 'heat'
            });
        }
        
        function addDustParticle(x, y, vx, vy) {
             particles.push({
                x: x + (Math.random()-0.5)*10,
                y: y + (Math.random()-0.5)*10,
                vx: vx * 0.5 + (Math.random()-0.5)*1,
                vy: vy * 0.5 + (Math.random()-0.5)*1,
                life: 0.4,
                color: Math.random() > 0.5 ? '#7f8c8d' : '#95a5a6',
                type: 'dust'
            });
        }

        function updatePhysics() {
            if (flagAnimation.active) return; 

            // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø«Ø¨Ø§Øª Ø§Ù„ØªØ§Ù… (Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©) ---
            if (rocket.landedPlanet) {
                let p = rocket.landedPlanet;
                
                // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ØºØ¨Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹
                if (inputs.up && rocket.fuel > 0) {
                    rocket.landedPlanet = null; // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
                    // Ø¯ÙØ¹Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø§Ø¨ØªØ¹Ø§Ø¯ Ø¹Ù† Ø§Ù„Ø³Ø·Ø­ ÙÙˆØ±Ø§Ù‹
                    rocket.x += Math.cos(rocket.angle) * 5;
                    rocket.y += Math.sin(rocket.angle) * 5;
                    rocket.vx += Math.cos(rocket.angle) * 2;
                    rocket.vy += Math.sin(rocket.angle) * 2;
                    document.getElementById('driving-mode').style.display = 'none';
                    // Ø³ÙŠØ³ØªÙ…Ø± Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠÙ†ÙØ° ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„Ø·ÙŠØ±Ø§Ù† ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø·Ø§Ø±
                } else {
                    // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (Ø¨Ø¯ÙˆÙ† ÙÙŠØ²ÙŠØ§Ø¡ Ø¬Ø§Ø°Ø¨ÙŠØ© = Ø«Ø¨Ø§Øª ØªØ§Ù…)
                    
                    // Ø­Ø³Ø§Ø¨ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ø¬Ù„Ø§Øª (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚)
                    let wheelOffset = 40;
                    let wheels = parts.filter(pt => pt.type === 'wheel');
                    if (wheels.length > 0) {
                        let maxWheelY = 0;
                        wheels.forEach(w => { if (w.y > maxWheelY) maxWheelY = w.y; });
                        wheelOffset = maxWheelY + 25;
                    } else {
                        // Ø¥Ø°Ø§ ÙÙ‚Ø¯Ù†Ø§ Ø§Ù„Ø¹Ø¬Ù„Ø§Øª ÙØ¬Ø£Ø©ØŒ Ù†Ù„ØºÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù‡Ø¨ÙˆØ· Ù„Ù†Ø¹ÙˆØ¯ Ù„Ù„ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                        rocket.landedPlanet = null;
                        return;
                    }

                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø­ÙˆÙ„ Ø§Ù„ÙƒÙˆÙƒØ¨
                    let currentAngle = Math.atan2(rocket.y - p.y, rocket.x - p.x);
                    let surfaceDist = p.radius + wheelOffset;

                    // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ©
                    let driveSpeed = 0.1 / (p.radius / 100); 
                    if (driveSpeed > 0.05) driveSpeed = 0.05; 
                    
                    let moveDir = 0;
                    if (inputs.right) { currentAngle += driveSpeed; moveDir = 1; rocket.wheelAngle += 0.3; }
                    if (inputs.left) { currentAngle -= driveSpeed; moveDir = -1; rocket.wheelAngle -= 0.3; }

                    // ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø±ÙŠØ§Ø¶ÙŠØ§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø³Ø±Ø¹Ø§Øª)
                    rocket.x = p.x + Math.cos(currentAngle) * surfaceDist;
                    rocket.y = p.y + Math.sin(currentAngle) * surfaceDist;
                    
                    // ØªØ«Ø¨ÙŠØª Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø·Ø­
                    rocket.angle = currentAngle;
                    
                    // ØªØµÙÙŠØ± Ø§Ù„Ø³Ø±Ø¹Ø§Øª ØªÙ…Ø§Ù…Ø§Ù‹
                    rocket.vx = 0;
                    rocket.vy = 0;

                    // ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØºØ¨Ø§Ø±
                    if (moveDir !== 0) {
                        let wheelX = rocket.x + Math.cos(rocket.angle + Math.PI/2) * 20; 
                        let wheelY = rocket.y + Math.sin(rocket.angle + Math.PI/2) * 20; 
                        addDustParticle(wheelX, wheelY, -moveDir * 2, -2);
                    }
                    
                    // Ø´Ø­Ù† Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙˆÙ‚ÙˆÙ
                    let hasSolar = parts.some(pt => pt.type === 'solar');
                    if (hasSolar && rocket.fuel < rocket.maxFuel) {
                        rocket.fuel += 0.02; 
                        document.getElementById('solar-charging').style.display = 'block';
                    } else {
                        document.getElementById('solar-charging').style.display = 'none';
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    document.getElementById('alt-val').innerText = "0";
                    document.getElementById('driving-mode').style.display = 'block';
                    
                    // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (Ù…Ø«Ù„ Ø§Ù„ØºØ¨Ø§Ø±)
                    for (let i = particles.length - 1; i >= 0; i--) {
                        let pt = particles[i];
                        pt.x += pt.vx; pt.y += pt.vy; pt.life -= 0.05;
                        if (pt.life <= 0) particles.splice(i, 1);
                    }
                    
                    // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¯Ø§Ù„Ø© Ù‡Ù†Ø§ Ù„Ù…Ù†Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ©
                    return;
                }
            }

            if (!hasLaunched) {
                let p = planets[2]; 
                rocket.x = p.x;
                rocket.y = p.y - p.radius - 60; 
                rocket.vx = 0;
                rocket.vy = 0;
                rocket.angle = -Math.PI / 2;

                if (inputs.up) {
                    if (rocket.fuel > 0) {
                        hasLaunched = true;
                        document.getElementById('launch-status').innerText = "Ø§Ù†Ø·Ù„Ø§Ù‚!";
                        document.getElementById('launch-status').style.color = "#ffeb3b";
                    } else {
                        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆÙ‚ÙˆØ¯!");
                    }
                }
                return; 
            }

            // Solar Charging Logic
            let hasSolar = parts.some(p => p.type === 'solar');
            if (hasSolar && rocket.fuel < rocket.maxFuel) {
                rocket.fuel += 0.02; 
                document.getElementById('solar-charging').style.display = 'block';
            } else {
                document.getElementById('solar-charging').style.display = 'none';
            }

            // Fuel Consumption
            if (inputs.up && rocket.fuel > 0) {
                let consumptionRate = 0;
                let totalThrust = 0;
                parts.forEach(p => {
                    if (p.def.thrust) {
                        totalThrust += p.def.thrust;
                        consumptionRate += p.def.consumption;
                    }
                });
                rocket.fuel -= consumptionRate;
                if (rocket.fuel < 0) rocket.fuel = 0;
                rocket.vx += Math.cos(rocket.angle) * totalThrust;
                rocket.vy += Math.sin(rocket.angle) * totalThrust;
            }

            let fuelPercent = Math.floor((rocket.fuel / rocket.maxFuel) * 100);
            let fuelEl = document.getElementById('fuel-val');
            fuelEl.innerText = fuelPercent + '%';
            if (fuelPercent < 20) {
                fuelEl.style.color = 'red';
                document.getElementById('fuel-low-warning').style.display = 'block';
            } else {
                fuelEl.style.color = '#00e676';
                document.getElementById('fuel-low-warning').style.display = 'none';
            }

            let totalGx = 0, totalGy = 0;
            let nearestDist = Infinity;
            let nearestPlanet = null;
            
            camera.shakeX = 0;
            camera.shakeY = 0;
            let inAtmosphere = false;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            let distFromEarth = Math.sqrt((rocket.x - planets[2].x)**2 + (rocket.y - planets[2].y)**2);
            let altFromEarth = distFromEarth - planets[2].radius;

            let targetZoom = 0.4; 
            if (altFromEarth < 500) targetZoom = 1.2; 
            else if (altFromEarth < 2000) targetZoom = 0.9; 
            else if (altFromEarth < 10000) targetZoom = 0.6; 
            camera.zoom += (targetZoom - camera.zoom) * 0.02;

            planets.forEach(p => {
                let dx = rocket.x - p.x;
                let dy = rocket.y - p.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                let angle = Math.atan2(dy, dx);
                
                if (dist < p.radius + 6000) { 
                    let g = (p.radius * 2.5) / dist; 
                    totalGx -= Math.cos(angle) * g * 0.05;
                    totalGy -= Math.sin(angle) * g * 0.05;
                }

                if (p.atm && dist < p.radius + 10000) {
                    inAtmosphere = true;
                    let altitude = dist - p.radius;
                    let density = Math.max(0, 1 - (altitude / 10000)) * p.atmDensity;
                    let dragFactor = 0.001 * density;
                    if (rocket.chuteDeployed) dragFactor *= 20; 
                    
                    rocket.vx *= (1 - dragFactor);
                    rocket.vy *= (1 - dragFactor);

                    let speed = Math.sqrt(rocket.vx*rocket.vx + rocket.vy*rocket.vy);
                    if (speed > 6 && density > 0.1 && !rocket.chuteDeployed) {
                        let shakeIntensity = (speed - 6) * 0.5 * density;
                        camera.shakeX = (Math.random() - 0.5) * shakeIntensity;
                        camera.shakeY = (Math.random() - 0.5) * shakeIntensity;
                        let noseX = rocket.x + Math.cos(rocket.angle) * 30;
                        let noseY = rocket.y + Math.sin(rocket.angle) * 30;
                        addHeatParticle(noseX, noseY, rocket.vx, rocket.vy);
                        document.getElementById('heat-warning').style.display = 'block';
                    } else {
                        document.getElementById('heat-warning').style.display = 'none';
                    }
                }

                if (dist < nearestDist) {
                    nearestDist = dist;
                    nearestPlanet = p;
                }
            });
            
            if (!inAtmosphere) {
                 document.getElementById('heat-warning').style.display = 'none';
            }

            rocket.vx += totalGx;
            rocket.vy += totalGy;

            if (inputs.left) rocket.angle -= 0.04;
            if (inputs.right) rocket.angle += 0.04;
            if (inputs.down) { rocket.vx *= 0.95; rocket.vy *= 0.95; }

            rocket.x += rocket.vx;
            rocket.y += rocket.vy;

            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                if (p.life <= 0) particles.splice(i, 1);
            }

            asteroids.forEach(a => {
                let dx = rocket.x - a.x;
                let dy = rocket.y - a.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < a.size + 40) {
                    let angle = Math.atan2(dy, dx);
                    rocket.vx += Math.cos(angle) * 2;
                    rocket.vy += Math.sin(angle) * 2;
                }
            });

            // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‡Ø¨ÙˆØ· ÙˆØ§Ù„Ù‚ÙŠØ§Ø¯Ø© (Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù‡Ø¨ÙˆØ·) ---
            let drivingModeEl = document.getElementById('driving-mode');
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ù‡Ø¨ÙˆØ·
            let wheelOffset = 40; 
            let wheels = parts.filter(p => p.type === 'wheel');
            if (wheels.length > 0) {
                let maxWheelY = 0;
                wheels.forEach(w => { if (w.y > maxWheelY) maxWheelY = w.y; });
                wheelOffset = maxWheelY + 25; 
            } else {
                 wheelOffset = 60; 
            }

            if (nearestPlanet && nearestDist < nearestPlanet.radius + wheelOffset) {
                if (Math.abs(rocket.vx) > 8 || Math.abs(rocket.vy) > 8) {
                    // ØªØ­Ø·Ù… Ø¨Ø³ÙŠØ·
                    let angle = Math.atan2(rocket.y - nearestPlanet.y, rocket.x - nearestPlanet.x);
                    rocket.vx = Math.cos(angle) * 10; 
                    rocket.vy = Math.sin(angle) * 10;
                    rocket.x = nearestPlanet.x + Math.cos(angle) * (nearestPlanet.radius + wheelOffset + 5);
                    rocket.y = nearestPlanet.y + Math.sin(angle) * (nearestPlanet.radius + wheelOffset + 5);
                } else if (!inputs.up) {
                    // Ù‡Ø¨ÙˆØ· Ù†Ø§Ø¬Ø­
                    if (!nearestPlanet.visited && nearestPlanet.type !== 'earth') {
                        triggerWin(nearestPlanet);
                    } else {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ†Ø§ Ø¹Ø¬Ù„Ø§ØªØŒ Ù†Ù†ØªÙ‚Ù„ Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø«Ø¨Ø§Øª (landedPlanet)
                        if (wheels.length > 0) {
                            rocket.landedPlanet = nearestPlanet; // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø«Ø§Ø¨Øª
                            
                            // Ø¶Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø²Ø§ÙˆÙŠØ© ÙÙˆØ±Ø§Ù‹ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
                            let angle = Math.atan2(rocket.y - nearestPlanet.y, rocket.x - nearestPlanet.x);
                            rocket.angle = angle;
                            rocket.x = nearestPlanet.x + Math.cos(angle) * (nearestPlanet.radius + wheelOffset);
                            rocket.y = nearestPlanet.y + Math.sin(angle) * (nearestPlanet.radius + wheelOffset);
                            rocket.vx = 0; rocket.vy = 0;
                        } else {
                            // Ù‡Ø¨ÙˆØ· Ø¹Ø§Ø¯ÙŠ Ø¨Ø¯ÙˆÙ† Ø¹Ø¬Ù„Ø§Øª (ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ)
                            drivingModeEl.style.display = 'none';
                            let angle = Math.atan2(rocket.y - nearestPlanet.y, rocket.x - nearestPlanet.x);
                            rocket.vx = 0; rocket.vy = 0;
                            rocket.x = nearestPlanet.x + Math.cos(angle) * (nearestPlanet.radius + wheelOffset);
                            rocket.y = nearestPlanet.y + Math.sin(angle) * (nearestPlanet.radius + wheelOffset);
                        }

                        if (rocket.chuteDeployed) {
                            rocket.chuteDeployed = false;
                            document.getElementById('chute-btn').classList.remove('deployed');
                            document.getElementById('chute-btn').innerText = "ÙØªØ­ Ø§Ù„Ù…Ø¸Ù„Ø© (P)";
                        }
                    }
                } else {
                    drivingModeEl.style.display = 'none';
                }
            } else {
                drivingModeEl.style.display = 'none';
            }

            let target = planets[targetPlanetIndex];
            let dx = target.x - rocket.x;
            let dy = target.y - rocket.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            document.getElementById('dist-val').innerText = Math.floor((dist - target.radius)/10);
            
            if (nearestPlanet) {
                document.getElementById('alt-val').innerText = Math.floor(nearestDist - nearestPlanet.radius);
            }

            let angleToTarget = Math.atan2(dy, dx);
            let arrow = document.getElementById('nav-arrow');
            arrow.style.transform = `translate(-50%, -50%) rotate(${angleToTarget + Math.PI/2}rad)`;
        }

        function triggerWin(planet) {
            flagAnimation.active = true;
            flagAnimation.planet = planet;
            flagAnimation.frame = 0;
            flagAnimation.x = rocket.x;
            flagAnimation.y = rocket.y;
            planet.visited = true;
            setTimeout(() => {
                document.getElementById('success-screen').classList.add('active');
                document.getElementById('planet-name-display').innerText = planet.name;
                document.getElementById('planet-fact-display').innerText = planet.fact;
                document.getElementById('flight-hud').style.display = 'none';
                document.getElementById('nav-arrow').style.display = 'none';
            }, 2000);
        }

        function continueMission() {
            document.getElementById('success-screen').classList.remove('active');
            document.getElementById('flight-hud').style.display = 'block';
            document.getElementById('nav-arrow').style.display = 'block';
            flagAnimation.active = false;
            updateTarget();
            let angle = Math.atan2(rocket.y - flagAnimation.planet.y, rocket.x - flagAnimation.planet.x);
            rocket.x += Math.cos(angle) * 100;
            rocket.y += Math.sin(angle) * 100;
            rocket.vx = Math.cos(angle) * 2;
            rocket.vy = Math.sin(angle) * 2;
        }

        function drawWorkshop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'rgba(0, 210, 255, 0.05)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let x = 0; x < canvas.width; x += GRID_SIZE) { ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); }
            for (let y = 0; y < canvas.height; y += GRID_SIZE) { ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); }
            ctx.stroke();

            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(camera.zoom, camera.zoom);
            ctx.translate(-camera.x, -camera.y);
            parts.forEach(p => p.draw(ctx, false));
            if (selectedPart) {
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]);
                ctx.strokeRect(selectedPart.x - selectedPart.def.w/2 - 5, selectedPart.y - selectedPart.def.h/2 - 5, selectedPart.def.w + 10, selectedPart.def.h + 10);
                ctx.setLineDash([]);
            }
            ctx.restore();
        }

        function drawFlight() {
            let nearestPlanet = null;
            let minDistance = Infinity;
            planets.forEach(p => {
                let d = Math.sqrt((rocket.x - p.x)**2 + (rocket.y - p.y)**2) - p.radius;
                if (d < minDistance) { minDistance = d; nearestPlanet = p; }
            });

            // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† ÙŠØ­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

            let skyColor = [5, 5, 5]; 
            let starOpacity = 1.0;

            if (nearestPlanet && nearestPlanet.atm && minDistance < 10000) {
                let alt = minDistance;
                if (alt < 3000) {
                    let t = alt / 3000;
                    skyColor = interpolateColor([135, 206, 235], [65, 105, 225], t); 
                    starOpacity = 0;
                } else if (alt < 7000) {
                    let t = (alt - 3000) / 4000;
                    skyColor = interpolateColor([65, 105, 225], [25, 25, 112], t); 
                    starOpacity = t * 0.5; 
                } else if (alt < 10000) {
                    let t = (alt - 7000) / 3000;
                    skyColor = interpolateColor([25, 25, 112], [5, 5, 5], t); 
                    starOpacity = 0.5 + t * 0.5;
                }
            }

            ctx.fillStyle = `rgb(${skyColor[0]}, ${skyColor[1]}, ${skyColor[2]})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (starOpacity > 0) {
                ctx.fillStyle = `rgba(255, 255, 255, ${starOpacity})`;
                stars.forEach(s => {
                    let sx = (s.x - rocket.x * 0.1 + canvas.width/2);
                    let sy = (s.y - rocket.y * 0.1 + canvas.height/2);
                    sx = (sx % 4000 + 4000) % 4000; 
                    sy = (sy % 4000 + 4000) % 4000;
                    ctx.beginPath(); ctx.arc(sx, sy, s.size, 0, Math.PI*2); ctx.fill();
                });
            }

            ctx.save();
            ctx.translate(canvas.width/2 + camera.shakeX, canvas.height/2 + camera.shakeY);
            ctx.scale(camera.zoom, camera.zoom);
            ctx.translate(-rocket.x, -rocket.y);

            ctx.fillStyle = '#555';
            asteroids.forEach(a => {
                ctx.save(); ctx.translate(a.x, a.y); ctx.rotate(a.angle);
                ctx.beginPath(); ctx.moveTo(-a.size/2, -a.size/2); ctx.lineTo(a.size/2, -a.size/3); ctx.lineTo(a.size/2 + 10, a.size/2); ctx.lineTo(-a.size/2 + 5, a.size/2 - 5); ctx.closePath(); ctx.fill(); ctx.restore();
                a.angle += a.speedRot;
            });

            planets.forEach(p => {
                if (p.atm) {
                    let glowRadius = p.radius + 10000; 
                    let atmGrad = ctx.createRadialGradient(p.x, p.y, p.radius, p.x, p.y, glowRadius);
                    let glowColor = p.atmColor || 'rgba(255, 255, 255, 0.4)';
                    atmGrad.addColorStop(0, glowColor);
                    atmGrad.addColorStop(1, 'rgba(0, 0, 0, 0)'); 
                    ctx.fillStyle = atmGrad;
                    ctx.beginPath(); ctx.arc(p.x, p.y, glowRadius, 0, Math.PI*2); ctx.fill();

                    ctx.strokeStyle = glowColor; ctx.lineWidth = p.radius * 0.02; 
                    ctx.globalAlpha = 0.6; ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2); ctx.stroke(); ctx.globalAlpha = 1.0;
                }

                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2); ctx.fill();
                
                if (p.type === 'earth') {
                    ctx.fillStyle = '#27ae60'; 
                    ctx.beginPath(); ctx.arc(p.x - 500, p.y - 200, 400, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(p.x + 600, p.y + 300, 500, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(p.x + 100, p.y - 800, 300, 0, Math.PI*2); ctx.fill();
                    
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                    for(let i=0; i<5; i++) {
                        ctx.beginPath(); ctx.ellipse(p.x + Math.cos(Date.now()*0.0001 + i)*1000, p.y + Math.sin(Date.now()*0.0001 + i)*1000, 600, 200, i, 0, Math.PI*2); ctx.fill();
                    }

                    ctx.save();
                    ctx.translate(p.x, p.y - p.radius);
                    ctx.fillStyle = '#2e7d32'; ctx.fillRect(-500, 0, 1000, 100); 
                    ctx.fillStyle = '#444'; ctx.beginPath(); ctx.moveTo(-80, 0); ctx.lineTo(80, 0); ctx.lineTo(100, 30); ctx.lineTo(-100, 30); ctx.closePath(); ctx.fill();
                    ctx.fillStyle = '#222'; ctx.beginPath(); ctx.moveTo(-20, 0); ctx.lineTo(20, 0); ctx.lineTo(0, 15); ctx.fill();
                    ctx.fillStyle = '#7f8c8d'; ctx.fillRect(-70, -220, 20, 220);
                    ctx.strokeStyle = '#555'; ctx.lineWidth = 2;
                    ctx.beginPath(); for(let y = 0; y < 220; y+=20) { ctx.moveTo(-70, -y); ctx.lineTo(-50, -y-20); ctx.moveTo(-50, -y); ctx.lineTo(-70, -y-20); } ctx.stroke();
                    ctx.strokeStyle = '#ccc'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(-60, -220); ctx.lineTo(-60, -250); ctx.stroke();

                    if (!hasLaunched) { 
                        ctx.fillStyle = '#c0392b'; ctx.fillRect(-50, -160, 50, 8); 
                        ctx.fillStyle = '#fff'; ctx.fillRect(0, -165, 10, 18); 
                        ctx.fillStyle = '#c0392b'; ctx.fillRect(-50, -90, 45, 6);
                    }

                    ctx.fillStyle = '#ecf0f1'; ctx.beginPath(); ctx.arc(90, -30, 20, 0, Math.PI*2); ctx.fill(); 
                    ctx.fillStyle = '#95a5a6'; ctx.fillRect(85, -10, 10, 10); 
                    ctx.strokeStyle = '#bdc3c7'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(70, -30); ctx.lineTo(20, -5); ctx.stroke();
                    ctx.restore();
                }

                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                if(p.type === 'moon') {
                    ctx.beginPath(); ctx.arc(p.x-50, p.y-50, 30, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(p.x+30, p.y+60, 40, 0, Math.PI*2); ctx.fill();
                } else if (p.type === 'jupiter') {
                    ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.fillRect(p.x - p.radius, p.y - 400, p.radius*2, 100); ctx.fillRect(p.x - p.radius, p.y + 100, p.radius*2, 150);
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.1)'; ctx.beginPath(); ctx.ellipse(p.x + 200, p.y + 200, 150, 80, 0, 0, Math.PI*2); ctx.fill();
                } else if (p.type === 'saturn') {
                    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(Math.PI / 6);
                    ctx.beginPath(); ctx.strokeStyle = 'rgba(200, 200, 150, 0.6)'; ctx.lineWidth = 50; ctx.ellipse(0, 0, p.radius * 1.8, p.radius * 0.6, 0, 0, Math.PI * 2); ctx.stroke();
                    ctx.strokeStyle = 'rgba(200, 200, 150, 0.3)'; ctx.lineWidth = 20; ctx.ellipse(0, 0, p.radius * 2.2, p.radius * 0.8, 0, 0, Math.PI * 2); ctx.stroke();
                    ctx.restore();
                }
                
                if (p.visited && p.type !== 'earth') {
                    ctx.save(); ctx.translate(p.x, p.y - p.radius);
                    ctx.fillStyle = '#fff'; ctx.fillRect(0, -40, 2, 40);
                    ctx.fillStyle = '#e74c3c'; ctx.fillRect(2, -40, 30, 20);
                    ctx.restore();
                }
            });

            particles.forEach(p => {
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
                let size = p.type === 'heat' ? 10 : 5 + (1-p.life)*10;
                if (p.type === 'dust') size = 3;
                ctx.beginPath(); ctx.arc(p.x, p.y, size, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;

            ctx.save();
            ctx.translate(rocket.x, rocket.y);
            ctx.rotate(rocket.angle + Math.PI/2);
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… rocket.wheelAngle Ø§Ù„Ø°ÙŠ ØªØªØ­ÙƒÙ… Ø¨Ù‡ Ø£Ù†Øª
            parts.forEach(p => p.draw(ctx, true, rocket.wheelAngle));
            ctx.restore();

            if (flagAnimation.active) {
                flagAnimation.frame++;
                ctx.save();
                let angle = Math.atan2(rocket.y - flagAnimation.planet.y, rocket.x - flagAnimation.planet.x);
                let surfaceX = flagAnimation.planet.x + Math.cos(angle) * flagAnimation.planet.radius;
                let surfaceY = flagAnimation.planet.y + Math.sin(angle) * flagAnimation.planet.radius;
                
                ctx.translate(surfaceX, surfaceY);
                ctx.rotate(angle + Math.PI/2);
                
                ctx.fillStyle = '#fff';
                ctx.beginPath(); ctx.arc(20, -10, 8, 0, Math.PI*2); ctx.fill(); 
                ctx.fillRect(12, -10, 16, 20); 
                
                let h = Math.min(40, flagAnimation.frame * 2); 
                ctx.fillStyle = '#ccc'; ctx.fillRect(0, -h, 2, h);
                
                if (h >= 40) {
                    let w = Math.min(30, (flagAnimation.frame - 20) * 2);
                    if (w > 0) {
                        ctx.fillStyle = '#e74c3c'; 
                        ctx.fillRect(2, -40, w, 20);
                    }
                }
                ctx.restore();
            }

            ctx.restore();
        }
        // Ø²Ø²

        function interpolateColor(color1, color2, factor) {
            if (arguments.length < 3) { return color1; }
            var result = color1.slice();
            for (var i = 0; i < 3; i++) {
                result[i] = Math.round(result[i] + factor * (color2[i] - color1[i]));
            }
            return result;
        }

        function loop() {
            requestAnimationFrame(loop);
            if (gameState === 'WORKSHOP') {
                drawWorkshop();
            } else if (gameState === 'FLY') {
                updatePhysics();
                drawFlight();
            }
        }
        loop();

    </script>
</body>
</html>